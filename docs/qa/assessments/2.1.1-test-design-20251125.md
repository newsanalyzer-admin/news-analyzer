# Test Design Document: Story 2.1.1 - Wikidata Entity Lookup

**Story ID:** 2.1.1
**Story Title:** Wikidata Entity Lookup
**Assessment Date:** 2025-11-25
**QA Analyst:** Quinn (Test Architect)
**Implementation File:** `reasoning-service/app/services/wikidata_client.py`
**Test File:** `reasoning-service/tests/test_wikidata_client.py`

---

## Executive Summary

This test design covers the Wikidata Entity Lookup functionality, which enables querying external knowledge bases to link extracted entities to authoritative Wikidata records. The implementation provides SPARQL and API-based search with caching, rate limiting, and confidence scoring.

**Risk Assessment:** MEDIUM-HIGH
- External API dependency creates availability risk
- Core functionality for entity linking pipeline
- Caching/rate limiting failures could cause cascading issues

---

## Acceptance Criteria Breakdown

### AC1: Query Wikidata SPARQL endpoint for entity by name

| Scenario ID | Description | Test Level | Priority | Rationale |
|------------|-------------|------------|----------|-----------|
| 2.1.1-UNIT-001 | Search returns valid candidates for known entity | Unit | P0 | Core happy path |
| 2.1.1-UNIT-002 | Search handles empty string input | Unit | P1 | Input validation |
| 2.1.1-UNIT-003 | Search handles special characters in entity name | Unit | P1 | SPARQL injection prevention |
| 2.1.1-UNIT-004 | SPARQL query escapes quotes properly | Unit | P1 | Security/correctness |
| 2.1.1-INTG-001 | End-to-end SPARQL query returns real Wikidata results | Integration | P1 | Verify actual API contract |

### AC2: Support multiple entity types (Person, Organization, Place, Event)

| Scenario ID | Description | Test Level | Priority | Rationale |
|------------|-------------|------------|----------|-----------|
| 2.1.1-UNIT-005 | EntityType enum contains all required types | Unit | P0 | Contract validation |
| 2.1.1-UNIT-006 | Search with PERSON type filters correctly | Unit | P1 | Type filtering |
| 2.1.1-UNIT-007 | Search with ORGANIZATION type filters correctly | Unit | P1 | Type filtering |
| 2.1.1-UNIT-008 | Search with GOVERNMENT_ORG type filters correctly | Unit | P1 | Type filtering |
| 2.1.1-UNIT-009 | Search with LOCATION type filters correctly | Unit | P1 | Type filtering |
| 2.1.1-UNIT-010 | Search with EVENT type filters correctly | Unit | P1 | Type filtering |
| 2.1.1-UNIT-011 | Search without type returns all entity types | Unit | P1 | Default behavior |
| 2.1.1-UNIT-012 | Type-to-QID mapping is correct for all types | Unit | P0 | Data accuracy |

### AC3: Return Wikidata QID

| Scenario ID | Description | Test Level | Priority | Rationale |
|------------|-------------|------------|----------|-----------|
| 2.1.1-UNIT-013 | WikidataCandidate includes qid field | Unit | P0 | Core output contract |
| 2.1.1-UNIT-014 | QID format is valid (Q followed by digits) | Unit | P1 | Data validation |
| 2.1.1-UNIT-015 | QID is extractable from full URI | Unit | P2 | URI parsing |
| 2.1.1-UNIT-016 | to_dict() includes qid in output | Unit | P1 | Serialization |

### AC4: Handle rate limiting (max 1 request/second)

| Scenario ID | Description | Test Level | Priority | Rationale |
|------------|-------------|------------|----------|-----------|
| 2.1.1-UNIT-017 | MIN_REQUEST_INTERVAL constant equals 1.0 | Unit | P0 | Contract validation |
| 2.1.1-UNIT-018 | Rapid consecutive calls are throttled | Unit | P0 | Rate limit enforcement |
| 2.1.1-UNIT-019 | Rate limiter tracks per-client state | Unit | P1 | Isolation |
| 2.1.1-UNIT-020 | Calls after interval complete without delay | Unit | P2 | Performance |
| 2.1.1-PERF-001 | Rate limiting adds ~1s delay between calls | Performance | P2 | Timing accuracy |

### AC5: Cache results for 24 hours

| Scenario ID | Description | Test Level | Priority | Rationale |
|------------|-------------|------------|----------|-----------|
| 2.1.1-UNIT-021 | CACHE_TTL_SECONDS equals 86400 (24 hours) | Unit | P0 | Contract validation |
| 2.1.1-UNIT-022 | Repeated search returns cached result | Unit | P0 | Cache hit |
| 2.1.1-UNIT-023 | Cache key includes search query | Unit | P1 | Cache correctness |
| 2.1.1-UNIT-024 | Cache key includes entity type | Unit | P1 | Cache correctness |
| 2.1.1-UNIT-025 | Different queries use different cache entries | Unit | P1 | Cache isolation |
| 2.1.1-UNIT-026 | Cached call does not trigger rate limiter | Unit | P1 | Optimization |
| 2.1.1-UNIT-027 | Cache size limit (CACHE_MAX_SIZE=1000) is enforced | Unit | P2 | Memory management |

### AC6: Return top 5 candidates with confidence scores

| Scenario ID | Description | Test Level | Priority | Rationale |
|------------|-------------|------------|----------|-----------|
| 2.1.1-UNIT-028 | Default max_results is 5 | Unit | P0 | Contract validation |
| 2.1.1-UNIT-029 | Results limited to max_results parameter | Unit | P1 | Limit enforcement |
| 2.1.1-UNIT-030 | Each candidate has confidence score 0.0-1.0 | Unit | P0 | Score range |
| 2.1.1-UNIT-031 | Candidates sorted by confidence descending | Unit | P1 | Sort order |
| 2.1.1-UNIT-032 | Confidence score calculation uses label match | Unit | P1 | Scoring logic |
| 2.1.1-UNIT-033 | WikidataSearchResult includes candidate_count | Unit | P2 | Metadata |

### AC7: Handle network errors and timeouts gracefully

| Scenario ID | Description | Test Level | Priority | Rationale |
|------------|-------------|------------|----------|-----------|
| 2.1.1-UNIT-034 | Connection timeout returns empty result, not exception | Unit | P0 | Error handling |
| 2.1.1-UNIT-035 | HTTP 500 error returns empty result | Unit | P0 | Error handling |
| 2.1.1-UNIT-036 | HTTP 429 (rate limited) returns empty result | Unit | P1 | API rate limit |
| 2.1.1-UNIT-037 | Malformed JSON response returns empty result | Unit | P1 | Parsing errors |
| 2.1.1-UNIT-038 | DNS resolution failure returns empty result | Unit | P2 | Network errors |
| 2.1.1-UNIT-039 | SSL certificate error returns empty result | Unit | P2 | Security errors |
| 2.1.1-UNIT-040 | Error is logged with appropriate level | Unit | P1 | Observability |

### AC8: Log all queries for debugging

| Scenario ID | Description | Test Level | Priority | Rationale |
|------------|-------------|------------|----------|-----------|
| 2.1.1-UNIT-041 | Search logs entity name at INFO level | Unit | P1 | Debug logging |
| 2.1.1-UNIT-042 | Search logs entity type filter if provided | Unit | P2 | Debug logging |
| 2.1.1-UNIT-043 | Cache hit logs at DEBUG level | Unit | P2 | Performance logging |
| 2.1.1-UNIT-044 | API call logs at DEBUG level | Unit | P2 | Debug logging |
| 2.1.1-UNIT-045 | Error conditions log at ERROR level | Unit | P1 | Error tracking |

---

## Test Level Justification

### Unit Tests (Primary Level)

**Rationale:** The WikidataClient is a well-isolated service with clear interfaces. Mock-based unit tests provide:
- Fast execution (~ms per test)
- No external dependencies
- Deterministic results
- Full coverage of edge cases

**Mock Strategy:**
- Mock `requests.get()` for HTTP calls
- Mock `time.sleep()` for rate limiting tests
- Use `pytest-mock` fixtures

### Integration Tests (Secondary Level)

**Rationale:** Limited integration tests verify the actual Wikidata API contract hasn't changed.

**Scope:**
- One smoke test against live SPARQL endpoint
- One smoke test against wbsearchentities API
- Run only in CI with network access

**Constraints:**
- Mark with `@pytest.mark.integration`
- Skip in local dev without network
- Respect rate limits (add delays)

### Performance Tests (Tertiary Level)

**Rationale:** Validate rate limiting timing behavior.

**Scope:**
- Measure actual delay between throttled calls
- Verify cache lookup is sub-millisecond

---

## Priority Distribution

| Priority | Count | Percentage | Coverage Focus |
|----------|-------|------------|----------------|
| P0 | 10 | 22% | Core contracts, critical error handling |
| P1 | 24 | 53% | Type filtering, caching, logging |
| P2 | 11 | 24% | Edge cases, performance, memory |
| P3 | 0 | 0% | N/A |

**Total Scenarios:** 45

---

## Test Data Requirements

### Positive Test Data

| Entity | Expected QID | Entity Type |
|--------|--------------|-------------|
| "Environmental Protection Agency" | Q217173 | GOVERNMENT_ORG |
| "Elizabeth Warren" | Q434706 | PERSON |
| "United States Congress" | Q11268 | GOVERNMENT_ORG |
| "Washington, D.C." | Q61 | LOCATION |

### Negative Test Data

| Input | Expected Behavior |
|-------|-------------------|
| "" (empty string) | Empty result, no error |
| "xyznonexistent12345" | Empty result, no error |
| "'; DROP TABLE--" | Escaped, empty result |
| String with Unicode | Proper encoding handling |

### Mock Response Templates

```python
# Successful wbsearchentities response
MOCK_SUCCESS_RESPONSE = {
    "search": [
        {
            "id": "Q217173",
            "label": "Environmental Protection Agency",
            "description": "US federal government agency",
            "aliases": ["EPA", "US EPA"]
        }
    ]
}

# Empty response
MOCK_EMPTY_RESPONSE = {"search": []}

# Error response
MOCK_ERROR_RESPONSE = {"error": {"code": "maxlag", "info": "Server overloaded"}}
```

---

## Dependencies and Prerequisites

### Test Infrastructure
- pytest >= 7.0
- pytest-mock >= 3.10
- pytest-asyncio (if async tests added)
- responses or requests-mock for HTTP mocking

### Environment Variables
- None required for unit tests
- `WIKIDATA_INTEGRATION_TESTS=1` to enable integration tests

### CI/CD Considerations
- Unit tests: Run on every PR
- Integration tests: Run nightly or on merge to main
- Performance tests: Run weekly

---

## Existing Test Coverage Analysis

**Current test file:** `reasoning-service/tests/test_wikidata_client.py`

The existing tests cover many scenarios. Gaps identified:

| Gap ID | Missing Coverage | Scenario ID |
|--------|-----------------|-------------|
| GAP-001 | SPARQL injection prevention | 2.1.1-UNIT-003 |
| GAP-002 | Cache key composition verification | 2.1.1-UNIT-023, 024 |
| GAP-003 | Rate limiter state isolation | 2.1.1-UNIT-019 |
| GAP-004 | SSL certificate error handling | 2.1.1-UNIT-039 |

---

## Sign-off

| Role | Name | Date | Status |
|------|------|------|--------|
| QA Analyst | Quinn | 2025-11-25 | Completed |
| Developer | - | - | Pending Review |
| Tech Lead | - | - | Pending Approval |

---

## Appendix: Test Scenario Details

### 2.1.1-UNIT-001: Search returns valid candidates for known entity

**Given:** WikidataClient is initialized
**When:** search("Environmental Protection Agency", EntityType.GOVERNMENT_ORG) is called
**Then:** Result contains at least one candidate with QID "Q217173"
**And:** Candidate has label "Environmental Protection Agency"
**And:** Candidate has confidence score > 0.8

### 2.1.1-UNIT-017: MIN_REQUEST_INTERVAL constant equals 1.0

**Given:** WikidataClient class is imported
**When:** MIN_REQUEST_INTERVAL attribute is accessed
**Then:** Value equals 1.0 (seconds)

### 2.1.1-UNIT-018: Rapid consecutive calls are throttled

**Given:** WikidataClient is initialized
**And:** time.sleep is mocked
**When:** search() is called twice in rapid succession
**Then:** time.sleep() is called with approximately 1.0 seconds
**And:** Both calls complete successfully

### 2.1.1-UNIT-034: Connection timeout returns empty result, not exception

**Given:** WikidataClient is initialized
**And:** requests.get is mocked to raise requests.exceptions.Timeout
**When:** search("any entity") is called
**Then:** Result is WikidataSearchResult with empty candidates list
**And:** No exception is raised to caller
**And:** Error is logged

