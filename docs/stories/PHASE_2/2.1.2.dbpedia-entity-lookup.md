# Story 2.1.2: DBpedia Entity Lookup

## Status
Draft

## Story
**As a** system,
**I want to** query DBpedia for matching entities when Wikidata returns no results,
**so that** I have a fallback knowledge base for entity linking.

## Acceptance Criteria
1. Query DBpedia Lookup API for entity by name
2. Support entity type filtering (Person, Organisation, Place)
3. Return DBpedia URI (e.g., `dbr:United_States_Environmental_Protection_Agency`)
4. Handle API errors gracefully
5. Cache results for 24 hours
6. Return top 5 candidates with confidence scores
7. Integrate with WikidataClient as fallback source

## Tasks / Subtasks
- [ ] Create DBpediaClient class (AC: 1, 2)
  - [ ] Implement Lookup API query builder
  - [ ] Map NewsAnalyzer types to DBpedia classes
  - [ ] Parse JSON response to extract URIs and labels
- [ ] Implement caching layer (AC: 5)
  - [ ] Create cache key format: `dbpedia:{entity_type}:{normalized_name}`
  - [ ] Set 24-hour TTL
  - [ ] Share cache implementation with WikidataClient
- [ ] Add candidate scoring (AC: 6)
  - [ ] Use refCount from API as relevance signal
  - [ ] Score by name similarity
  - [ ] Return sorted top 5 candidates
- [ ] Implement error handling (AC: 4)
  - [ ] Handle HTTP errors
  - [ ] Handle malformed responses
  - [ ] Handle network timeouts
  - [ ] Log all errors with context
- [ ] Integrate as fallback (AC: 7)
  - [ ] Create fallback logic in entity_linker.py
  - [ ] Only call DBpedia if Wikidata returns 0 results
- [ ] Write unit tests
  - [ ] Test successful query
  - [ ] Test type filtering
  - [ ] Test caching behavior
  - [ ] Test error handling

## Dev Notes

### Relevant Source Tree
```
reasoning-service/
├── app/
│   ├── services/
│   │   ├── dbpedia_client.py   # NEW - Create this file
│   │   ├── wikidata_client.py  # Story 2.1.1 - reference for patterns
│   │   └── entity_linker.py    # Story 2.1.4 - will integrate this
└── tests/
    └── test_dbpedia_client.py  # NEW - Create this file
```

### DBpedia Lookup API
- URL: `https://lookup.dbpedia.org/api/search`
- Method: GET
- Parameters:
  - `query`: Search term (required)
  - `type`: DBpedia class filter (optional)
  - `maxResults`: Limit (default 5)
- Response: JSON with `docs` array

### Example Request
```
GET https://lookup.dbpedia.org/api/search?query=EPA&type=Organisation&maxResults=5
```

### Example Response
```json
{
  "docs": [
    {
      "resource": ["http://dbpedia.org/resource/United_States_Environmental_Protection_Agency"],
      "label": ["United States Environmental Protection Agency"],
      "type": ["http://dbpedia.org/ontology/GovernmentAgency"],
      "comment": ["The EPA is an independent executive agency..."],
      "refCount": [1250]
    }
  ]
}
```

### Entity Type to DBpedia Class Mapping
| NewsAnalyzer Type | DBpedia Class |
|-------------------|---------------|
| person | Person |
| government_org | GovernmentAgency, Organisation |
| organization | Organisation |
| location | Place, City, Country |
| event | Event |

### Code Pattern
Follow same singleton pattern as WikidataClient:
```python
_client_instance = None

def get_dbpedia_client() -> DBpediaClient:
    global _client_instance
    if _client_instance is None:
        _client_instance = DBpediaClient()
    return _client_instance
```

### Shared Cache Utility
Consider extracting cache logic to shared utility:
```python
# app/utils/cache.py
from cachetools import TTLCache

entity_cache = TTLCache(maxsize=10000, ttl=86400)  # 24 hours

def get_cached(key: str) -> Optional[Any]:
    return entity_cache.get(key)

def set_cached(key: str, value: Any):
    entity_cache[key] = value
```

## Testing

### Test File Location
`reasoning-service/tests/test_dbpedia_client.py`

### Testing Standards
- Use pytest framework
- Mock HTTP requests using `responses` or `pytest-httpx`
- Test both success and failure cases
- Minimum 90% coverage for this module

### Test Cases
```python
def test_search_entity_success():
    """Test successful entity search returns candidates"""

def test_search_with_type_filter():
    """Test Organisation filter returns only organizations"""

def test_caching_returns_cached_result():
    """Test second call returns cached result"""

def test_empty_results_handled():
    """Test empty docs array returns empty list"""

def test_malformed_response_handled():
    """Test malformed JSON doesn't crash"""

def test_network_error_returns_empty():
    """Test network errors return empty list, not exception"""
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-25 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

## QA Results
_To be filled by QA agent_
