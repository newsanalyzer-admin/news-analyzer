# Story 2.3.2: Public Entity Pages

## Status
Draft

## Story
**As a** user,
**I want to** view entity details on a public web page with embedded JSON-LD,
**so that** I can see all information about an entity and search engines can index it.

## Acceptance Criteria
1. Create `/entities/{id}` public page in frontend
2. Display entity details in human-readable format
3. Embed JSON-LD in `<script type="application/ld+json">`
4. Show external links (Wikidata, DBpedia, official website)
5. Support canonical URLs for entities
6. Add Open Graph meta tags for social sharing
7. Page loads in under 2 seconds
8. Responsive design (mobile-friendly)

## Tasks / Subtasks
- [ ] Create entity detail page (AC: 1, 2)
  - [ ] Create `/entities/[id]/page.tsx` route
  - [ ] Fetch entity data from API
  - [ ] Display entity name, type, description
  - [ ] Display all properties in organized sections
- [ ] Add JSON-LD embedding (AC: 3)
  - [ ] Create JsonLdEmbed component
  - [ ] Fetch JSON-LD from API
  - [ ] Embed in <script> tag in <head>
- [ ] Display external links (AC: 4)
  - [ ] Show Wikidata link with icon
  - [ ] Show DBpedia link with icon
  - [ ] Show official website link
  - [ ] Open links in new tab
- [ ] Implement canonical URLs (AC: 5)
  - [ ] Add <link rel="canonical"> tag
  - [ ] Use consistent URL pattern
  - [ ] Handle Wikidata ID-based URLs
- [ ] Add Open Graph meta tags (AC: 6)
  - [ ] og:title, og:description, og:type
  - [ ] og:url, og:image
  - [ ] Twitter card tags
- [ ] Optimize performance (AC: 7)
  - [ ] Server-side rendering for SEO
  - [ ] Optimize API calls
  - [ ] Lazy load non-critical components
- [ ] Ensure responsive design (AC: 8)
  - [ ] Mobile layout
  - [ ] Tablet layout
  - [ ] Desktop layout
- [ ] Write tests
  - [ ] Test page renders correctly
  - [ ] Test JSON-LD embedded
  - [ ] Test meta tags present

## Dev Notes

### Relevant Source Tree
```
frontend/src/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îî‚îÄ‚îÄ entities/
‚îÇ       ‚îî‚îÄ‚îÄ [id]/
‚îÇ           ‚îî‚îÄ‚îÄ page.tsx        # NEW - Create entity detail page
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ JsonLdEmbed.tsx         # NEW - JSON-LD script component
‚îÇ   ‚îú‚îÄ‚îÄ ExternalLinks.tsx       # NEW - External link display
‚îÇ   ‚îî‚îÄ‚îÄ EntityCard.tsx          # EXISTING - Reference for styling
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îî‚îÄ‚îÄ api/
‚îÇ       ‚îî‚îÄ‚îÄ entities.ts         # EXISTING - Add getEntityJsonLd
‚îî‚îÄ‚îÄ types/
    ‚îî‚îÄ‚îÄ entity.ts               # EXISTING - Reference for types
```

### Page Component Structure

```tsx
// app/entities/[id]/page.tsx

import { Metadata } from 'next';
import { notFound } from 'next/navigation';
import { getEntity, getEntityJsonLd } from '@/lib/api/entities';
import JsonLdEmbed from '@/components/JsonLdEmbed';
import ExternalLinks from '@/components/ExternalLinks';

// Generate metadata for SEO
export async function generateMetadata({ params }): Promise<Metadata> {
  const entity = await getEntity(params.id);
  if (!entity) return {};

  const title = `${entity.name} - NewsAnalyzer`;
  const description = entity.properties?.description ||
    `${entity.schemaOrgType}: ${entity.name}`;

  return {
    title,
    description,
    openGraph: {
      title,
      description,
      type: 'article',
      url: `https://newsanalyzer.org/entities/${params.id}`,
    },
    twitter: {
      card: 'summary',
      title,
      description,
    },
    alternates: {
      canonical: `https://newsanalyzer.org/entities/${params.id}`,
    },
  };
}

export default async function EntityPage({ params }) {
  const entity = await getEntity(params.id);
  if (!entity) notFound();

  const jsonLd = await getEntityJsonLd(params.id);

  return (
    <>
      {/* Embed JSON-LD for search engines */}
      <JsonLdEmbed data={jsonLd} />

      <main className="container mx-auto px-4 py-8">
        {/* Header */}
        <header className="mb-8">
          <span className="inline-block px-3 py-1 bg-blue-100 text-blue-800
                          rounded-full text-sm mb-2">
            {entity.schemaOrgType}
          </span>
          <h1 className="text-3xl font-bold text-gray-900">
            {entity.name}
          </h1>
          {entity.properties?.description && (
            <p className="mt-2 text-gray-600">
              {entity.properties.description}
            </p>
          )}
        </header>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
          {/* Main content */}
          <div className="lg:col-span-2">
            <EntityProperties entity={entity} />
          </div>

          {/* Sidebar */}
          <aside className="lg:col-span-1">
            <ExternalLinks entity={entity} />
            <EnrichmentStatus entity={entity} />
          </aside>
        </div>
      </main>
    </>
  );
}
```

### JsonLdEmbed Component

```tsx
// components/JsonLdEmbed.tsx

interface JsonLdEmbedProps {
  data: Record<string, any>;
}

export default function JsonLdEmbed({ data }: JsonLdEmbedProps) {
  return (
    <script
      type="application/ld+json"
      dangerouslySetInnerHTML={{ __html: JSON.stringify(data) }}
    />
  );
}
```

### ExternalLinks Component

```tsx
// components/ExternalLinks.tsx

import { ExternalLinkIcon } from '@heroicons/react/outline';

interface ExternalLinksProps {
  entity: {
    properties?: {
      wikidata_id?: string;
      dbpedia_uri?: string;
      url?: string;
    };
  };
}

export default function ExternalLinks({ entity }: ExternalLinksProps) {
  const { wikidata_id, dbpedia_uri, url } = entity.properties || {};

  const links = [
    wikidata_id && {
      label: 'Wikidata',
      url: `https://www.wikidata.org/wiki/${wikidata_id}`,
      icon: 'üåê',
    },
    dbpedia_uri && {
      label: 'DBpedia',
      url: dbpedia_uri,
      icon: 'üìö',
    },
    url && {
      label: 'Official Website',
      url: url,
      icon: 'üîó',
    },
  ].filter(Boolean);

  if (links.length === 0) return null;

  return (
    <div className="bg-white rounded-lg shadow p-4 mb-4">
      <h3 className="text-lg font-semibold mb-3">External Links</h3>
      <ul className="space-y-2">
        {links.map((link) => (
          <li key={link.url}>
            <a
              href={link.url}
              target="_blank"
              rel="noopener noreferrer"
              className="flex items-center text-blue-600 hover:text-blue-800"
            >
              <span className="mr-2">{link.icon}</span>
              {link.label}
              <ExternalLinkIcon className="w-4 h-4 ml-1" />
            </a>
          </li>
        ))}
      </ul>
    </div>
  );
}
```

### EntityProperties Component

```tsx
// components/EntityProperties.tsx

interface EntityPropertiesProps {
  entity: Entity;
}

export default function EntityProperties({ entity }: EntityPropertiesProps) {
  const { properties, schemaOrgType } = entity;

  // Group properties by category
  const categories = groupPropertiesByType(schemaOrgType, properties);

  return (
    <div className="bg-white rounded-lg shadow p-6">
      <h2 className="text-xl font-semibold mb-4">Details</h2>

      {categories.map((category) => (
        <div key={category.name} className="mb-6">
          <h3 className="text-lg font-medium text-gray-700 mb-2">
            {category.name}
          </h3>
          <dl className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            {category.properties.map((prop) => (
              <div key={prop.key}>
                <dt className="text-sm font-medium text-gray-500">
                  {prop.label}
                </dt>
                <dd className="mt-1 text-sm text-gray-900">
                  {formatPropertyValue(prop.value)}
                </dd>
              </div>
            ))}
          </dl>
        </div>
      ))}

      {/* Alternate Names */}
      {properties?.alternateName && (
        <div className="mb-6">
          <h3 className="text-lg font-medium text-gray-700 mb-2">
            Also Known As
          </h3>
          <div className="flex flex-wrap gap-2">
            {(Array.isArray(properties.alternateName)
              ? properties.alternateName
              : [properties.alternateName]
            ).map((name) => (
              <span
                key={name}
                className="px-2 py-1 bg-gray-100 rounded text-sm"
              >
                {name}
              </span>
            ))}
          </div>
        </div>
      )}
    </div>
  );
}

function formatPropertyValue(value: any): React.ReactNode {
  if (value === null || value === undefined) return '‚Äî';

  // URL
  if (typeof value === 'string' && value.startsWith('http')) {
    return (
      <a href={value} target="_blank" rel="noopener noreferrer"
         className="text-blue-600 hover:underline">
        {value}
      </a>
    );
  }

  // Date
  if (typeof value === 'string' && /^\d{4}-\d{2}-\d{2}/.test(value)) {
    return new Date(value).toLocaleDateString();
  }

  // Object (nested)
  if (typeof value === 'object') {
    return value.name || JSON.stringify(value);
  }

  return String(value);
}
```

### API Client Update

```typescript
// lib/api/entities.ts

export async function getEntityJsonLd(id: string): Promise<Record<string, any>> {
  const response = await fetch(
    `${JAVA_API_URL}/api/entities/${id}/jsonld`,
    {
      headers: {
        'Accept': 'application/ld+json',
      },
      next: { revalidate: 3600 }, // Cache for 1 hour
    }
  );

  if (!response.ok) {
    throw new Error(`Failed to fetch JSON-LD for entity ${id}`);
  }

  return response.json();
}
```

### Meta Tags Example

```html
<!-- Rendered in <head> -->
<title>United States Environmental Protection Agency - NewsAnalyzer</title>
<meta name="description" content="GovernmentOrganization: United States Environmental Protection Agency" />
<link rel="canonical" href="https://newsanalyzer.org/entities/550e8400-..." />

<!-- Open Graph -->
<meta property="og:title" content="United States Environmental Protection Agency - NewsAnalyzer" />
<meta property="og:description" content="GovernmentOrganization: United States Environmental Protection Agency" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://newsanalyzer.org/entities/550e8400-..." />

<!-- Twitter -->
<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="United States Environmental Protection Agency - NewsAnalyzer" />
<meta name="twitter:description" content="GovernmentOrganization: United States Environmental Protection Agency" />
```

## Testing

### Test File Location
`frontend/src/__tests__/entities/[id]/page.test.tsx`

### Testing Standards
- Use Jest + React Testing Library
- Test server-side rendering
- Test meta tags
- Test responsive layouts

### Test Cases
```typescript
describe('EntityPage', () => {
  it('renders entity name and type', async () => {
    // Test heading and type badge
  });

  it('embeds JSON-LD script', async () => {
    // Test <script type="application/ld+json"> present
  });

  it('generates correct meta tags', async () => {
    // Test og:title, og:description, canonical
  });

  it('displays external links when available', async () => {
    // Test Wikidata and DBpedia links rendered
  });

  it('handles entity not found', async () => {
    // Test 404 page displayed
  });

  it('renders correctly on mobile', async () => {
    // Test responsive layout
  });
});
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-25 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

## QA Results
_To be filled by QA agent_
