# Story 2.1.1: Wikidata Entity Lookup

## Status
Draft

## Story
**As a** system,
**I want to** query Wikidata for matching entities by name and type,
**so that** I can link extracted entities to authoritative external records with unique identifiers.

## Acceptance Criteria
1. Query Wikidata SPARQL endpoint for entity by name
2. Support multiple entity types (Person, Organization, Place, Event)
3. Return Wikidata QID (e.g., Q30 for United States)
4. Handle rate limiting (max 1 request/second for public endpoint)
5. Cache results for 24 hours (in-memory or Redis)
6. Return top 5 candidates with confidence scores
7. Handle network errors and timeouts gracefully
8. Log all queries for debugging and monitoring

## Tasks / Subtasks
- [ ] Create WikidataClient class (AC: 1, 2)
  - [ ] Implement SPARQL query builder for entity search
  - [ ] Support entity type filtering via Wikidata type constraints
  - [ ] Parse SPARQL JSON response to extract QIDs and labels
- [ ] Implement rate limiting (AC: 4)
  - [ ] Add request throttling (1 req/sec)
  - [ ] Queue requests when rate limited
- [ ] Implement caching layer (AC: 5)
  - [ ] Create cache key format: `wikidata:{entity_type}:{normalized_name}`
  - [ ] Set 24-hour TTL
  - [ ] Support cache bypass for testing
- [ ] Add candidate scoring (AC: 6)
  - [ ] Score by name similarity (Levenshtein distance)
  - [ ] Score by type match
  - [ ] Return sorted top 5 candidates
- [ ] Implement error handling (AC: 7, 8)
  - [ ] Handle HTTP 429 (rate limited)
  - [ ] Handle HTTP 5xx (server errors)
  - [ ] Handle network timeouts (5 second default)
  - [ ] Log all errors with context
- [ ] Write unit tests
  - [ ] Test successful query
  - [ ] Test rate limiting behavior
  - [ ] Test caching behavior
  - [ ] Test error handling

## Dev Notes

### Relevant Source Tree
```
reasoning-service/
├── app/
│   ├── services/
│   │   ├── wikidata_client.py  # NEW - Create this file
│   │   ├── entity_extractor.py # Existing - reference for service patterns
│   │   └── owl_reasoner.py     # Existing - reference for singleton pattern
│   └── api/
│       └── entities.py         # Existing - has stub /entities/link endpoint
└── tests/
    └── test_wikidata_client.py # NEW - Create this file
```

### Wikidata SPARQL Endpoint
- URL: `https://query.wikidata.org/sparql`
- Format: GET with `query` param, Accept: `application/sparql-results+json`
- Rate limit: ~60 requests/minute (undocumented, be conservative)

### Example SPARQL Query
```sparql
SELECT ?item ?itemLabel ?itemDescription ?instanceOf WHERE {
  ?item rdfs:label "Environmental Protection Agency"@en .
  ?item wdt:P31 ?instanceOf .
  SERVICE wikibase:label { bd:serviceParam wikibase:language "en". }
}
LIMIT 5
```

### Entity Type to Wikidata Type Mapping
| NewsAnalyzer Type | Wikidata Type (P31) |
|-------------------|---------------------|
| person | Q5 (human) |
| government_org | Q327333 (government agency) or Q43229 (organization) |
| organization | Q43229 (organization) |
| location | Q515 (city), Q6256 (country), Q82794 (geographic region) |
| event | Q1190554 (event) |

### Dependencies to Add
```
# requirements.txt additions
requests>=2.31.0  # HTTP client (may already exist)
cachetools>=5.3.0 # In-memory caching with TTL
```

### Code Pattern Reference
Follow the singleton pattern used in `owl_reasoner.py`:
```python
_client_instance = None

def get_wikidata_client() -> WikidataClient:
    global _client_instance
    if _client_instance is None:
        _client_instance = WikidataClient()
    return _client_instance
```

## Testing

### Test File Location
`reasoning-service/tests/test_wikidata_client.py`

### Testing Standards
- Use pytest framework
- Mock HTTP requests using `responses` or `pytest-httpx`
- Test both success and failure cases
- Minimum 90% coverage for this module

### Test Cases
```python
def test_search_entity_success():
    """Test successful entity search returns candidates"""

def test_search_entity_with_type_filter():
    """Test type filtering narrows results"""

def test_rate_limiting_queues_requests():
    """Test requests are throttled to 1/second"""

def test_caching_returns_cached_result():
    """Test second call returns cached result"""

def test_cache_expires_after_ttl():
    """Test cache expires after 24 hours"""

def test_network_error_handled():
    """Test network errors don't crash, return empty"""

def test_rate_limit_response_handled():
    """Test HTTP 429 triggers retry with backoff"""
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-25 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

## QA Results
_To be filled by QA agent_
