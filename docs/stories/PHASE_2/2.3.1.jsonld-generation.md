# Story 2.3.1: JSON-LD Generation Enhancement

## Status
Draft

## Story
**As a** system,
**I want to** generate complete JSON-LD with external references and enriched properties,
**so that** entity data is fully interoperable with the semantic web and search engines.

## Acceptance Criteria
1. Include `@id` with canonical entity URL
2. Include `sameAs` array with external URLs (Wikidata, DBpedia)
3. Include all enriched Schema.org properties
4. Support nested objects (e.g., Person → worksFor → Organization)
5. Validate output against JSON-LD spec
6. Generate valid JSON-LD for all entity types
7. Support multiple output formats (compact, expanded, framed)

## Tasks / Subtasks
- [ ] Enhance JsonLdService (AC: 1, 2, 3)
  - [ ] Add @id generation with canonical URL pattern
  - [ ] Build sameAs array from external IDs
  - [ ] Include all Schema.org properties from entity
- [ ] Implement nested object support (AC: 4)
  - [ ] Detect reference properties (worksFor, location, etc.)
  - [ ] Generate nested Schema.org objects
  - [ ] Handle circular references
- [ ] Add JSON-LD validation (AC: 5)
  - [ ] Validate @context
  - [ ] Validate @type against Schema.org
  - [ ] Validate required properties
- [ ] Support all entity types (AC: 6)
  - [ ] Person JSON-LD generation
  - [ ] Organization JSON-LD generation
  - [ ] Place JSON-LD generation
  - [ ] Event JSON-LD generation
- [ ] Add format options (AC: 7)
  - [ ] Compact (default, minimal)
  - [ ] Expanded (all properties explicit)
  - [ ] Framed (specific structure)
- [ ] Write unit tests
  - [ ] Test each entity type
  - [ ] Test nested objects
  - [ ] Test validation
  - [ ] Test format options

## Dev Notes

### Relevant Source Tree
```
backend/src/main/java/org/newsanalyzer/
├── service/
│   ├── JsonLdService.java      # NEW - Create this file
│   └── SchemaOrgMapper.java    # EXISTING - Reference for patterns
├── controller/
│   └── EntityController.java   # MODIFY - Add JSON-LD endpoint
└── dto/
    └── JsonLdDTO.java          # NEW - Response wrapper

reasoning-service/app/services/
└── jsonld_generator.py         # NEW - Python version for API

backend/src/test/java/org/newsanalyzer/
└── service/JsonLdServiceTest.java # NEW
```

### Canonical URL Pattern

```
https://newsanalyzer.org/entities/{entity_id}
```

Or using Wikidata ID when available:
```
https://newsanalyzer.org/entities/wd:{wikidata_id}
```

### JSON-LD Output Examples

#### Government Organization (EPA)

```json
{
  "@context": "https://schema.org",
  "@type": "GovernmentOrganization",
  "@id": "https://newsanalyzer.org/entities/550e8400-e29b-41d4-a716-446655440001",
  "name": "United States Environmental Protection Agency",
  "alternateName": ["EPA", "U.S. EPA", "Environmental Protection Agency"],
  "url": "https://www.epa.gov",
  "foundingDate": "1970-12-02",
  "description": "Independent agency of the United States federal government...",
  "sameAs": [
    "https://www.wikidata.org/wiki/Q217173",
    "http://dbpedia.org/resource/United_States_Environmental_Protection_Agency"
  ],
  "parentOrganization": {
    "@type": "GovernmentOrganization",
    "name": "United States federal government",
    "@id": "https://newsanalyzer.org/entities/wd:Q35657"
  },
  "location": {
    "@type": "Place",
    "name": "Washington, D.C.",
    "address": {
      "@type": "PostalAddress",
      "addressLocality": "Washington",
      "addressRegion": "DC",
      "addressCountry": "US"
    }
  },
  "areaServed": {
    "@type": "Country",
    "name": "United States"
  }
}
```

#### Person (Senator)

```json
{
  "@context": "https://schema.org",
  "@type": "Person",
  "@id": "https://newsanalyzer.org/entities/wd:Q434706",
  "name": "Elizabeth Warren",
  "alternateName": ["Senator Warren", "Elizabeth Ann Warren"],
  "jobTitle": "United States Senator",
  "birthDate": "1949-06-22",
  "birthPlace": {
    "@type": "Place",
    "name": "Oklahoma City, Oklahoma"
  },
  "nationality": {
    "@type": "Country",
    "name": "United States"
  },
  "sameAs": [
    "https://www.wikidata.org/wiki/Q434706",
    "http://dbpedia.org/resource/Elizabeth_Warren"
  ],
  "worksFor": {
    "@type": "GovernmentOrganization",
    "name": "United States Senate",
    "@id": "https://newsanalyzer.org/entities/wd:Q66096"
  },
  "memberOf": {
    "@type": "PoliticalParty",
    "name": "Democratic Party"
  },
  "image": "https://upload.wikimedia.org/wikipedia/commons/..."
}
```

### JsonLdService Implementation

```java
package org.newsanalyzer.service;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.node.ObjectNode;
import com.fasterxml.jackson.databind.node.ArrayNode;

@Service
public class JsonLdService {

    private final ObjectMapper mapper;
    private final String baseUrl;

    @Value("${app.base-url:https://newsanalyzer.org}")
    private String appBaseUrl;

    public JsonLdService(ObjectMapper mapper) {
        this.mapper = mapper;
        this.baseUrl = appBaseUrl;
    }

    /**
     * Generate JSON-LD representation for entity.
     */
    public ObjectNode generateJsonLd(Entity entity) {
        ObjectNode jsonLd = mapper.createObjectNode();

        // Core JSON-LD structure
        jsonLd.put("@context", "https://schema.org");
        jsonLd.put("@type", entity.getSchemaOrgType());
        jsonLd.put("@id", generateCanonicalId(entity));

        // Basic properties
        jsonLd.put("name", entity.getName());

        // Add alternate names if present
        if (hasProperty(entity, "alternateName")) {
            jsonLd.set("alternateName", toArrayNode(getProperty(entity, "alternateName")));
        }

        // Add sameAs with external links
        ArrayNode sameAs = generateSameAs(entity);
        if (sameAs.size() > 0) {
            jsonLd.set("sameAs", sameAs);
        }

        // Add type-specific properties
        addTypeSpecificProperties(jsonLd, entity);

        // Add enriched properties from Wikidata/DBpedia
        addEnrichedProperties(jsonLd, entity);

        return jsonLd;
    }

    private String generateCanonicalId(Entity entity) {
        String wikidataId = entity.getWikidataId();
        if (wikidataId != null) {
            return baseUrl + "/entities/wd:" + wikidataId;
        }
        return baseUrl + "/entities/" + entity.getId();
    }

    private ArrayNode generateSameAs(Entity entity) {
        ArrayNode sameAs = mapper.createArrayNode();

        String wikidataId = entity.getWikidataId();
        if (wikidataId != null) {
            sameAs.add("https://www.wikidata.org/wiki/" + wikidataId);
        }

        String dbpediaUri = entity.getDbpediaUri();
        if (dbpediaUri != null) {
            sameAs.add(dbpediaUri);
        }

        // Add any existing sameAs from properties
        Object existing = getProperty(entity, "sameAs");
        if (existing instanceof List) {
            ((List<?>) existing).forEach(url -> sameAs.add(url.toString()));
        }

        return sameAs;
    }

    private void addTypeSpecificProperties(ObjectNode jsonLd, Entity entity) {
        switch (entity.getSchemaOrgType()) {
            case "Person":
                addPersonProperties(jsonLd, entity);
                break;
            case "GovernmentOrganization":
            case "Organization":
                addOrganizationProperties(jsonLd, entity);
                break;
            case "Place":
                addPlaceProperties(jsonLd, entity);
                break;
            case "Event":
                addEventProperties(jsonLd, entity);
                break;
        }
    }

    private void addPersonProperties(ObjectNode jsonLd, Entity entity) {
        addIfPresent(jsonLd, entity, "jobTitle");
        addIfPresent(jsonLd, entity, "birthDate");
        addIfPresent(jsonLd, entity, "deathDate");
        addIfPresent(jsonLd, entity, "image");

        // Nested worksFor
        addNestedOrg(jsonLd, entity, "worksFor");

        // Nested memberOf (political party)
        addNestedOrg(jsonLd, entity, "memberOf");

        // Nationality as nested Country
        if (hasProperty(entity, "nationality")) {
            ObjectNode nationality = mapper.createObjectNode();
            nationality.put("@type", "Country");
            nationality.put("name", getStringProperty(entity, "nationality"));
            jsonLd.set("nationality", nationality);
        }
    }

    private void addOrganizationProperties(ObjectNode jsonLd, Entity entity) {
        addIfPresent(jsonLd, entity, "url");
        addIfPresent(jsonLd, entity, "foundingDate");
        addIfPresent(jsonLd, entity, "dissolutionDate");
        addIfPresent(jsonLd, entity, "description");

        // Nested parentOrganization
        addNestedOrg(jsonLd, entity, "parentOrganization");

        // Nested location
        if (hasProperty(entity, "location")) {
            ObjectNode location = mapper.createObjectNode();
            location.put("@type", "Place");
            location.put("name", getStringProperty(entity, "location"));
            jsonLd.set("location", location);
        }

        // areaServed
        if (hasProperty(entity, "areaServed")) {
            ObjectNode area = mapper.createObjectNode();
            area.put("@type", "Country");
            area.put("name", getStringProperty(entity, "areaServed"));
            jsonLd.set("areaServed", area);
        }
    }

    private void addNestedOrg(ObjectNode jsonLd, Entity entity, String propertyName) {
        if (hasProperty(entity, propertyName)) {
            Object value = getProperty(entity, propertyName);
            if (value instanceof Map) {
                // Already structured
                jsonLd.set(propertyName, mapper.valueToTree(value));
            } else {
                // Simple string - wrap in object
                ObjectNode nested = mapper.createObjectNode();
                nested.put("@type", "Organization");
                nested.put("name", value.toString());
                jsonLd.set(propertyName, nested);
            }
        }
    }

    /**
     * Validate JSON-LD output.
     */
    public List<String> validate(ObjectNode jsonLd) {
        List<String> errors = new ArrayList<>();

        // Required: @context
        if (!jsonLd.has("@context")) {
            errors.add("Missing @context");
        }

        // Required: @type
        if (!jsonLd.has("@type")) {
            errors.add("Missing @type");
        } else {
            String type = jsonLd.get("@type").asText();
            if (!isValidSchemaOrgType(type)) {
                errors.add("Invalid @type: " + type);
            }
        }

        // Required: name
        if (!jsonLd.has("name")) {
            errors.add("Missing name property");
        }

        return errors;
    }
}
```

### REST Endpoint

```java
// Add to EntityController.java

@GetMapping("/{id}/jsonld")
@Operation(summary = "Get entity as JSON-LD")
@Produces("application/ld+json")
public ResponseEntity<ObjectNode> getEntityJsonLd(@PathVariable UUID id) {
    Entity entity = entityService.findById(id);
    ObjectNode jsonLd = jsonLdService.generateJsonLd(entity);

    return ResponseEntity.ok()
        .contentType(MediaType.parseMediaType("application/ld+json"))
        .body(jsonLd);
}
```

### JSON-LD Validation

Use a lightweight validation approach:
1. Check required properties (@context, @type, name)
2. Validate @type against known Schema.org types
3. Validate property names against Schema.org vocabulary (optional, strict mode)

```java
private static final Set<String> VALID_SCHEMA_ORG_TYPES = Set.of(
    "Person", "Organization", "GovernmentOrganization",
    "Place", "Event", "Thing", "CreativeWork",
    "PoliticalParty", "NewsMediaOrganization"
);

private boolean isValidSchemaOrgType(String type) {
    return VALID_SCHEMA_ORG_TYPES.contains(type);
}
```

## Testing

### Test File Location
`backend/src/test/java/org/newsanalyzer/service/JsonLdServiceTest.java`

### Testing Standards
- Use JUnit 5
- Test all entity types
- Validate output structure
- Minimum 90% coverage

### Test Cases
```java
@Test
void generateJsonLd_governmentOrg_hasRequiredFields() {
    // Test @context, @type, @id, name, sameAs
}

@Test
void generateJsonLd_person_includesJobAndBirth() {
    // Test Person includes jobTitle, birthDate
}

@Test
void generateJsonLd_includesSameAs() {
    // Test Wikidata and DBpedia links in sameAs
}

@Test
void generateJsonLd_nestedWorksFor() {
    // Test Person worksFor generates nested object
}

@Test
void generateJsonLd_canonicalId_usesWikidata() {
    // Test @id uses Wikidata ID when available
}

@Test
void validate_missingContext_returnsError() {
    // Test validation catches missing @context
}

@Test
void validate_invalidType_returnsError() {
    // Test validation catches invalid @type
}

@Test
void generateJsonLd_allEntityTypes() {
    // Test all 6 entity types generate valid JSON-LD
}
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-25 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

## QA Results
_To be filled by QA agent_
